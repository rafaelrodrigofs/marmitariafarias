<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exportar Cardápio - Anota.ai</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            color: white;
        }
        .export-button {
            background-color: #4CAF50;
        }
        .save-button {
            background-color: #2196F3;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        #status {
            margin: 20px;
            padding: 10px;
            border-radius: 5px;
        }
        .success {
            background-color: #dff0d8;
            color: #3c763d;
        }
        .error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Exportar Cardápio</h1>
        <button id="exportButton" class="button export-button" onclick="exportarCardapio()">Exportar Cardápio</button>
        <button id="saveButton" class="button save-button" onclick="salvarNoBanco()" disabled>Salvar no Banco</button>
        <div id="status"></div>
    </div>

    <script>
        let dadosCardapio = null;

        async function exportarCardapio() {
            const statusDiv = document.getElementById('status');
            const exportButton = document.getElementById('exportButton');
            const saveButton = document.getElementById('saveButton');
            
            try {
                exportButton.disabled = true;
                saveButton.disabled = true;
                statusDiv.innerHTML = 'Exportando cardápio...';
                statusDiv.className = '';

                const response = await fetch('https://api-menu.anota.ai/partnerauth/v2/nm-category/rest/simple-item/export/v2', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'eyJhbGciOiJIUzI1NiJ9.eyJpZHBhcnRuZXIiOiI2N2MwNGFmYjU5NWY2MzAwMTI4ODUwNDUiLCJpZHBhZ2UiOiI2NDM0MGM5YzYyODg0MDAwMTJhNmQ1MWMifQ.YYiAKDdkokeFpDEYy0bAkau5BYt7X4JqVoQPkK1Qjxc'
                    }
                });

                const responseData = await response.json();
                
                // Remove o campo week_prices de cada item dentro dos produtos
                responseData.data.forEach(grupo => {
                    if (grupo.itens && Array.isArray(grupo.itens)) {
                        grupo.itens = grupo.itens.map(item => {
                            const { week_prices, ...itemSemPrecos } = item;
                            return itemSemPrecos;
                        });
                    }
                });

                // Salva os dados para uso posterior
                dadosCardapio = responseData.data;

                console.log(dadosCardapio);

                // Envia os dados filtrados para o PHP salvar
                const saveResponse = await fetch('exportarCardapio.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosCardapio)
                });

                if (!saveResponse.ok) {
                    throw new Error('Erro ao salvar o arquivo');
                }

                statusDiv.innerHTML = 'Cardápio exportado com sucesso!';
                statusDiv.className = 'success';
                saveButton.disabled = false; // Habilita o botão de salvar
            } catch (error) {
                console.error('Erro:', error);
                statusDiv.innerHTML = 'Erro ao exportar o cardápio: ' + error.message;
                statusDiv.className = 'error';
            } finally {
                exportButton.disabled = false;
            }
        }

        async function salvarNoBanco() {
            const statusDiv = document.getElementById('status');
            const saveButton = document.getElementById('saveButton');
            
            try {
                if (!dadosCardapio) {
                    throw new Error('Nenhum dado disponível para salvar');
                }

                saveButton.disabled = true;
                statusDiv.innerHTML = 'Salvando produtos no banco de dados...';
                statusDiv.className = '';

                const saveResponse = await fetch('salvarProdutos.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosCardapio)
                });

                if (!saveResponse.ok) {
                    throw new Error('Erro ao salvar no banco de dados');
                }

                const result = await saveResponse.json();
                
                if (result.success) {
                    statusDiv.innerHTML = 'Produtos salvos no banco com sucesso!';
                    statusDiv.className = 'success';
                } else {
                    throw new Error(result.error || 'Erro ao salvar no banco de dados');
                }
            } catch (error) {
                console.error('Erro:', error);
                statusDiv.innerHTML = 'Erro ao salvar no banco: ' + error.message;
                statusDiv.className = 'error';
            } finally {
                saveButton.disabled = false;
            }
        }
    </script>
</body>
</html> 